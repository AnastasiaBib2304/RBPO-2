name: Build Application

on:
  pull_request:
    branches: [ "main" ]

jobs:
  build-app:
    runs-on: ubuntu-latest
    
    container:
      image: maven:3.9.10-eclipse-temurin-21
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set permissions for mvnw
        run: chmod u+x ./mvnw
        
      - name: Build with Maven
        run: ./mvnw -B clean package
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vuln-jar-files
          path: ./target/*.jar
  
  dependency-check:
    needs: build-app
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set permissions for mvnw
        run: chmod u+x ./mvnw
      
      - name: Download latest OWASP DC data
        run: |
          mkdir -p ~/.m2/repository/org/owasp/dependency-check-data
          curl -L -o ~/.m2/repository/org/owasp/dependency-check-data/dc.h2.zip \
            https://github.com/jeremylong/DependencyCheck/releases/latest/download/dc.h2.zip
          unzip -o ~/.m2/repository/org/owasp/dependency-check-data/dc.h2.zip \
            -d ~/.m2/repository/org/owasp/dependency-check-data/
      
      - name: Run OWASP Dependency Check
        run: |
          ./mvnw org.owasp:dependency-check-maven:check \
            -Dformats=html \
            -DsuppressionFiles=dependency-check-suppressions.xml \
            -DfailBuildOnCVSS=0 \
            -DskipTestScope=true \
            -DautoUpdate=false \
            -DnvdApiKey="" \
            -DnvdApiDelay=0
      
      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: ./target/dependency-check-report.html
        continue-on-error: true
  
  sast-scan:
    needs: build-app
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Убрал env секцию с токеном - будет использоваться бесплатная версия
      - name: Run Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          # Используем только бесплатные правила
          config: >
            p/default
            p/security-audit
          output: semgrep-results.sarif
          output-format: sarif
          quiet: true
        # Удаляем env секцию - Semgrep будет работать без токена
      
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep-sast
        continue-on-error: true
